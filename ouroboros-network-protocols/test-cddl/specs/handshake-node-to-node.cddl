;
; NodeToNode Handshake, v4 or higher
;

handshakeMessage
    = msgProposeVersions
    / msgAcceptVersion
    / msgRefuse
    / msgQueryReply

msgProposeVersions = [0, versionTable]
msgAcceptVersion   = [1, oldVersionNumber, oldNodeToNodeVersionData]
                   / [1, versionNumber, nodeToNodeVersionData]
msgRefuse          = [2, refuseReason]
msgQueryReply      = [3, versionTable]

; Entries must be sorted by version number. For testing, this is handled in `handshakeFix`.
versionTable = { * oldVersionNumber => oldNodeToNodeVersionData
               , *    versionNumber =>    nodeToNodeVersionData
               }

versionNumber = 11
oldVersionNumber = 7 / 8 / 9 / 10

anyVersionNumber = oldVersionNumber / versionNumber

; As of version 11
nodeToNodeVersionData = [ networkMagic, initiatorAndResponderDiffusionMode, query ]

oldNodeToNodeVersionData = [ networkMagic, initiatorAndResponderDiffusionMode ]

; range between 0 and 0xffffffff
networkMagic = 0..4294967295
initiatorAndResponderDiffusionMode = bool
query = bool

refuseReason
    = refuseReasonVersionMismatch
    / refuseReasonHandshakeDecodeError
    / refuseReasonRefused

refuseReasonVersionMismatch      = [0, [ *anyVersionNumber ] ]
refuseReasonHandshakeDecodeError = [1, anyVersionNumber, tstr]
refuseReasonRefused              = [2, anyVersionNumber, tstr]
